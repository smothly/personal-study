# 3장 워터마크

- 데이터 인입 시점에 워터마크가 어떻게 생성, 전파되는지, 출력 타임스탬프에는 어떤 영향을 주는지, 무한 데이터라를 다루기 위한 보장에 대한 설명

---

## 정의

- 이벤트 시간 윈도우 문제를 해결하기 위한 간단한 방법은 이벤트 시간 윈도우를 현재 처리 시간 기반으로 두는 것
  - 이벤트 시간과 처리 시간은 같을 수 없어 적절한 윈도우에 대한 보장이 없음
- 각 데이터는 논리적인 이벤트 시간 타임스탬프를 포함하고 있다는 가정
- ![스트리밍예시](http://streamingbook.net/static/images/figures/stsy_0301.png)
  - 파이프라인에서 처리되지 않은 데이터 중 가장 오래된 이벤트 시간에 해당하는 처리 중 부분의 가장 왼쪽 끝
    - 워터마크는 아직 완료되지않는 가장 오래된 작업이 갖는 단조증가(monotinically increasing) 타임스탬프이다.
      - 완결성(completness)
        - 타임스탬프 T인 지점 기준으로 그 이전의 모든 결과를 생성해도 올바르다.
        - 워터마크를 사용하면 윈도우를 닫을 수 있는 시점을 알 수 있음
      - 가시성(visibility)
        - 메시지가 파이프라인내에서 처리되지 않고 있으면, 워터마크가 진행되지 않음

---

## 소스 워터마크 생성

- 워터마크는 완벽하거나 휴리스틱하거나 둘 중 하나
- 휴리스틱은 지연 데이터가 발생할 수 있음을 인정

### 완벽한 워터마크 생성

- 워터마크가 그보다 작은 이벤트 시간을 갖는 데이터가 입력으로 들어오지 않도록 엄격히 보장해주어야 함
- 지연데이터를 고려할 필요가 없음
- 완벽한 워터마크를 생성할려면 입력에 대한 완벽한 지식이 필요하여 쉽지 않음
- 사례  
  - 인입 타임스탬프(ingress timestamp)
    - 시스템의 인입되는 시간을 데이터의 이벤트 시간이라고 함
    - 처리 시간을 추적
    - 이벤트 시간 진행과 윈도우 처리가 매우 쉬워짐
    - 실제 데이터의 이벤트 시간과 무관
  - 시간순으로 정렬된 정적 로그 데이터
    - 카프카 토픽처럼 각 분할에 단조 증가하는 이벤트 시간이 포함돼있는 정적 분할에 속하는 정적인 크기를 갖아야 함
    - 정적 분할 중 처리되지 않은 데이터의 가장 작은 이벤트시간을 추적
    - 웹 프론트에서 카프카로 이벤트 로그 남기는 경우

### 휴리스틱 워터마크 생성

- 워터마크보다 이른 이벤트 시간을 데이터를 만날 가능성이 적다는 추정
- 지연 데이터 처리를 고려해야 함
- 사례
  - 시간순으로 정렬된 동적 로그 데이터
    - 구조화된 동적 파일 = 파일 내에서는 이벤트 시간이 단조 증가 하지만, 파일간은 고정되지 않는 경우
    - 파일에서 처리되지 않은 데이터의 최소 이벤트 시간을 추적 + 증가율 모니터링, 네트워크 속도같은 외부 정보를 통해 정확환 휴리스틱 워터마크 구현
  - 구글 클라우드 Pub/Sub
    - 데이터가 순서를 보장하며 전달되지 않음
    - 사용자의 개입 없이 아키텍처 증가를 위함
    - 이 부분을 해결한 정확한 휴리스틱 워터마크를 3장 후반부에서 얘기함
- **소스에 대한 정보를 더 많이 알수록** 휴리스특이 향상되고 지연데이터를 더 적게 만남

---

## 워터마크 전파

- 단일 단계에서의 워터마크가 아닌 여러 단계의 관점에서의 워터마크
- 실제 파이프라인은 여러 단계임
- 개념적으로 워터마크도 시스템을 따라 흐른다.
- 단계의 경계마다 워터마크를 정의할 수 있음
- 입력 워터마크
  - 해당 단계의 모든 업스트림 진행 상황을 담고 있음.
  - 입력 워터마크를 생성하는 소스 고유의 함수로 볼 수 있음.
  - 모든 업스트림 소스와 해당 단계의 모든 샤드 분할/ 인스턴스의 출력 워터마크 중 최솟값으로 정의
- 출력 워터마크
  - 해당 단계의 진행정도
  - 처리 중인 모든 비지연 데이터의 이벤트 시간중 최솟값으로 정의
- 각 버퍼마다 자체 워터마크를 갖도록 해, 버퍼 진행 정도 추적가능
- 출력 워터마크는 다음 워터마크의 최소가 됨 ex) 데이터 수신하는 단계, 파이프라인 외부소스

### 워터마크 전파 이해하기

- 게임 사용자별 세션 길이 계산
  - 콘솔과 모바일을 분리함
  - 파이프라인 단계
    - 사용자별 세션 길이 구하기
    - 2분 단위로 윈도우를 나누워 세션 길이 전체평균을 계산
 
### 워터마크 전파와 출력 타임스탬프

- 윈도우에서 가장 오래된 지연 없는 데이터의 타임스탬프는 무한대까지 확장 될 수 있음
  - 제한하는 3가지 방법
    - 윈도우의 끝
    - 첫 번째 비지연 데이터의 타임 스탬프
    - 특정 데이터의 타임스탬프

### 백분위 워터마크
- 워터마크를 %로 표현하기
- 결과를 구체화하는 대기 시간과 결과의 정확성 간의 균형을 조절할 수 있는 방법을 제공

## 처리 시간 워터마크
- processing-time watermark
  - 이벤트 지연인지 처리하다가 지연인지 구분이 불가능하기 때문에 필요
  - 아직 완료되지 않은 가장 오래된 연산의 처리 시간 타임스탬프를 활용
  - 처리시간과 이벤트 시간이라는 두가지 영역 
  - 고정 윈도우에서의 워타마크 지연
    - ![고정윈도우워터마크지연](http://streamingbook.net/static/images/figures/stsy_0315.png)
    - 처리시간에서는 이상이 없고, 버퍼링하는 동안에 이벤트 시간이 증가하고 트리거 되면 감소하는 증세
  - 결론은, `처리 시간 워터마크`는 시스템 지연과 데이터 지연을 구분할 때 유용

## 사례 연구
- GCP Dataflow watermark
  - 각 워커에 일정 키 범위가 배정됨
    - ![워커 키 배정](http://streamingbook.net/static/images/figures/stsy_0317.png)
  - `GroupByKey` 연산이 수행 될 때마다 해당 키로 셔플되어야 함 
    - ![셔플](http://streamingbook.net/static/images/figures/stsy_0316.png)
  - 중앙집중식 워터마크 취합 과정
    - 모든 범위는 반드시 워터마크 보고
    - 워터마크 단조 증가
- apache flink watermark
  - 플링크는 워터마크를 데이터와 같은 흐름 내에서 추적하고 취합함
    - ![플링크 아키텍처](http://streamingbook.net/static/images/figures/stsy_0318.png)
  - 체크포인트도 같이 생성
  - keyBy연산은 워터마크와 체크포인트를 소비함
  - 장점
    - 줄어든 워터마크 전파 지연 및 현저히 낮은 워터마크 지연
    - 워터마크 집계에 대한 SPOF 없음
    - 타고난 확장성
  - 단점
    - 입력 조절 불편
    - 소스 워터마크 생성
- GCP Pub/Sub watermark
  - 메세지를 토픽에 게시하고 여러곳에서 토픽을 구독하는 방식
  - **순서를 보장하지 않음**
  - 휴리스틱하게 보내기 위한 가정
    - 10초 내의 **추정 대역**을 두어 지연 데이터 구분
    - 수신여부가 미확인 된 가장 오래된 publish timestamp를 통해 백로그 추적 가능
    - 기본 구독과 추적 구독
      - 기본 구독: 파이프라인이 실제 처리될 데이터를 읽을 목적
        - ![기본구독](http://streamingbook.net/static/images/figures/stsy_0319.png)
      - 추적 구독: 워터마크 추정을 위해 메타데이터를 위한 목적
        - ![추적구독](http://streamingbook.net/static/images/figures/stsy_0320.png)
      - 추적구독이 더 최근의 메시지를 조사할 수 있도록 구현
      - 조건
        - 추적구독이 기본구독보다 빨라야 함. 앞에서 말한 추정 대역만큼은 앞서야함
        - 추적 구독이 실시간에 가까워야 함
  - 추정 대역 안에서는 순서가 뒤바뀌더라도 불필요한 지연 데이터 방생이 없음을 보장

## 요약
- 메시지 이벤트 시간 사용
- 워터마크 생성
- 워터마크에서 출력 윈도우 타임스탬프 변화의 의미