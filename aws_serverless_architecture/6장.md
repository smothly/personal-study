# 6장 조율자 Lambda

---

## 6-1 Lambda 내부

### 이벤트 모델과 소스

- 아래와 같은 방식에 대해 응답합
  - AWS에서 발생된 이벤트
  - API Gateway를 통한 HTTP 요청
  - AWS SDK를 사용해 작성된 API 호출
  - AWS 콘솔을 이용한 호충

### 푸시(push)와 풀(pull) 이벤트 모델

- 푸시
  - s3 이벤트처럼 이벤트를 람다에 게시하고 함수 직접 호출
  - kinesis stereams 및 DynamoDB Streams를 제외하고는 모든 AWS 서비스는 푸시모델 사용
- 풀
  - 키네시스 스트림을 폴링하고 필요할 때 함수 호출

### 동시실행
- 현재는 계정당 100개로 동시 제한 (상향 요청 가능)
- 스트림 기반 이벤트 소스
  - 스트림 기반 이벤트 소스에서 함수 호출 동시성은 활성화된 샤드의 수와 같음
  - 레코드가 도착한 순서대로 처리, 오류 발견하면 레코드가 만료되거나 성공할때까지 재수행
- 비 스트림 기반 이벤트 소스
  - 초당 이벤트 x 함수 실행 기간
  
### 컨테이너 재사용
- 람다함수는 컨테이너에서 실행
- 함수가 특정 기간내에 재실행되면, 동일한 컨테이너를 재사용하여 초기화 프로세스(콜드)를 건너 뛸 수 있음.
- freeze/thaw 사이클 - 백그라운드 프로세스의 경우 재시작되므로 주의

### cold 람다 warm 람다
- 처음 시작했을 때와 두번째 시작 했을때와의 실행시간 차이
- cold start 예방법
  - Warm 람다 만들어 주기적으로 함수 실행
  - 초기화 및 설정코드를 이벤트 핸들러 밖으로 옮기기
  - 메모리양 늘리기 -> 자동으로 CPU도 올라감
  - 코드 줄이기
  - 다른언어 시도, 자바가 가장 큰 초기화 시간을 가짐.


---

## 6-2 프로그래밍 모델
### 함수 핸들러
- 함수의 진입점으로, event와 context를 파라미터로 전달 받음

### 이벤트 객체
- 람다를 호출한 이벤트 및 소스에 대한 정보
- JSON 객체

### 컨텍스트 객체
- 런타임에 대한 정보를 얻기 위한 많은 유용한 속성들
- 유용한 속성
  - getRemainingTimeInMills
  - functionName
  - functionVersion
  - invokedFunctionArn
  - memoryLimitInMB
  - awsRequestId
  - logGroupName
  - logStreamName
  - identity
  - clientContext

### 콜백 함수
- nodejs일 경우 해당
- request/response할 때 정보를 반환할 때 사용
- error와 result가 있음

### 로깅
- cloudwatch 확인. 적절한 로깅프레임워크를 사용하는 것이 중요

---

## 6-3 버전 관리 및 별칭 및 환경 변수
### 버전관리
- 이전 버전을 덮어 쓰지 않고 새 버전을 발행하여 실행할 수 있음
- 이전 버전은 편집할 수는 없지만 호출은 가능 arn이 다름

### 별칭
- prod/dev/stage등 버전 별 코드 관리할 때 유용

### 환경 변수
- SDK나 CLI, 람다 콘솔등을 통해서 추가 가능
- 코드내에서 해당 변수들 접근 가능
- KMS를 통해 암호화키 생성 가능, 복호화 하는 코드도 줌

---

## 6-4 CLI 사용
### 호출 명령어
- IAM 보안 구성이 잘 되어 있어야 한다.

### 함수 생성 및 배포
- create lambda policy를 추가하여 create-function호출

---

## 6-5 Lambda 패턴
### 비동기 폭포(Async waterfall)
- 폭포패턴은 함수의 결과를 다음 함수로 전달해 일련의 함수를 차례로 실행할 수 있음.
- 오류가나면 다음 작업 호출 되지 않음
- 비디오 목록을 가져오기 위한 일련의 aysnc함수 생성
  - 파라미터 구성
  - s3 리스트 호출
  - 데이터를 배열로 만들

### 직렬 및 병렬
- 직렬패턴은 폭포패턴과 비슷함
- 병렬 패턴은 완료를 기다리지 않고 병렬로 함수를 실행함

### 라이브러리 사용
- require에 다양한 라이브러리 사용가능
- SES 사용

---

## 6-6 Lambda 함수 테스트
### 로컬에서 테스트
### AWS에서 테스트
- 부하테스트도 구성하여 가능

---

## 연습문제
- 환경변수 가져오기
- 이메일 발송 Lambda 추가
- 테스트

## 요약
- 이벤트 모델
- 버전 관리 별칭 환경 변수
- CLI
- 비동기 폭포와 같은 패턴 및 라이브러리 생성
- 로컬 및 AWS에서 하는 Lambda 테스트


