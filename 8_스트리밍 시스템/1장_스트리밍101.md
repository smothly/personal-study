# 1장 스트리밍 101

---

### 용어: 스트리밍이란?

> 무한 데이터셋을 염두에 두고 설계된 데이터 처리 엔진의 유형(마이크로 배치 구현도 포함)

- ![배치와 스트리밍의 차이](https://quix.ai/wp-content/uploads/2021/08/Batch-vs-Stream-processing-1024x658.png)
- 과거엔 무한 데이터 처리(unbounded data procesing), 근사치 결과(approximate result)처럼 불림
- 데이터셋은 cardinality와 constitutuion의 속성을 가지며, 두 속성은 직교(orthogonal)한다.
  - cardinality = 기수
    - 데이터셋의 크기를 뜻함
      - 유한 데이터(bounded data)
      - 무한 데이터(unbounded data)
  - constitutuion = 구성
    - 데이터의 물리적 표현을 뜻함
    - 테이블
      - 특정 시점의 데이터 셋에 대한 전체적인 뷰
      - 전통 SQL에서 테이블 바탕으로 동작
    - 스트림
      - 시간에 따라 변화하는 데이터셋의 요소 단위 뷰(element-by-element view)
      - MapReduce 계통의 데이터 처리 시스템에서 스트림 바탕으로 동작

---

### 스트리밍의 한계?

- 람다 아키텍처
  > 동일한 계산을 수행하는 **배치 시스템과 스트리밍 시스템을 함께 운영**하는 것
  - 올바른 결과를 내는 배치 시스템
  - 낮은 지연 시간으로 부정확한 결과를 제공하는 스트리밍 시스템
  - 두 파이프라인을 구축 유지해야하는 번거로움 발생 => 카파(Kappa) 아키텍처 제안
- 배치와 스트리밍의 통합을 주장
  - 스트리밍이 배치를 이기기 위해 필요한 2가지
    - 정확성(correctness)
      - 일관성을 제공할 수 있는 스토리지(consistent storage)가 필요
      - 영구 상태를 유지할 수 있는 체크포인트 방법이 필요
      - 장애상황에서의 일관성 유지
      - 강한 일관성 = '정확히 한 번 처리(exactly-once)'은 필수적인 요소
    - 시간 판단 도구(tools for reasoning about time)
      - 다양한 이벤트 시간 왜곡을 갖는 unbounded unorderd data를 처리할 때 반드시 필요

---

### 이벤트 시간 vs 처리 시간

- 이벤트 시간(event time)

> 이벤트가 실제로 발생한 시간

- 처리 시간(processing time)

> 이벤트가 처리 시스템에서 관측된 시간

- 두 시간의 차이를 시간 왜곡이라고 부름. 시간 왜곡은 0일 수록 좋으나 다양한 요인에 따라 가변적
  - 공유된 리소스로 인한 제약 ex) 네트워크 혼잡, 공유환경 CPU 등
  - 소프트웨어 상의 원인 ex) 분산 시스템의 로직, 경쟁 상황
  - 데이터 자체의 특성들 ex) 데이터의 양이나 순서 변화, 키 분산
- ![이벤트 시간과 처리 시간에 따른 왜곡](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQowfoGiI3w6d6OWgYuNVZAPDPHWCAlcMcwuNaP_kryHr2TC2e-m7siW4HDcw5QEe7aIHM&usqp=CAU)
  - 두가지 유형의 왜곡
    - 처리 시간(proccessing time lag)
      - 수직으로 ideal과 reailty 선
      - 이벤트와 처리시간의 지연이 얼마나 발생했는지
    - 이벤트 시간(event time skew)
      - 수평으로 reality와 ideal 선
      - 이벤트시간 관점에서 현재 파이프라인이 얼마나 늦어지고 있는지
    - 같은 현상을 보는 두 가지 관점이라고 생각
  - 이벤트 시간을 `window`라는 단위로 잘라 일정 시간 경계에서 데이터셋을 유한하다고 판단하고 다루지만 그래도 정확성에 문제가 생길 수 있음.
  - 유한한 묶음으로 처리할려고 하는 시도 대신 불확실성을 다룰 수 있도록 도구를 설계해야 하는 니즈
    - 새로운 데이터가 도착하면 이전 데이터를 철회하거나 갱신할 수 있어야 함
    - 완결 시점이라는 개ㅐ념을 특정 경우를 위한 편리한 최적화로 간주

---

### 데이터 처리 패턴

#### 유한 데이터

- ![유한데이터 처리](https://www.oreilly.com/library/view/streaming-systems/9781491983867/assets/stsy_0102.png)
- 배치 엔진을 사용해서 유한한 비정형 데이터 풀에 데이터 처리엔진이 동작해 구조화된 데이터를 얻게됨

#### 무한 데이터: 배치

- 무한 데이터를 배치 처리에 적합한 유한 데이터셋의 집합으로 분할하는 것이 중요
- 고정 윈도우
  - ![무한데이터 고정윈도우 처리](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS0iTHJ0LMEdpgXWY2_5rtWGEg6xhqHEk3ntOHFvS_wh5AuAwckCfziorhsejN1RG4u45c&usqp=CAU)
  - 데이터 입력이 완료 됐다는 완결성(completeness)의 문제가 있음.
  - 이벤트 전송중 네트워크 지연 등
- 세션
  - ![무한데이터 세션 처리](https://www.oreilly.com/library/view/streaming-systems/9781491983867/assets/stsy_0104.png)
  - 세션의 활동 기간으로 정의
  - 여러 배치로 나누어진 세션은 이어질 수는 있으나 복잡도가 증가

#### 무한 데이터: 스트리밍

- 무한 데이터의 특성
  - 이벤트 시간 기준으로 뒤섞임
  - 이벤트 타임 왜곡이 발생
- **4가지 접근법**
  - 시간 무시(time agnositic)
    - 스트리밍 엔진은 기본적으로 데이터 전달 목적으로만 사용
    - 모든 스트리밍 시스템은 시간 무시 처리를 바로 지원
    - **필터링**
      - 도착한 데이터를 보고 특정 요소로 필터를 하기 때문에 이벤트 왜곡과 무관해짐
    - **내부 조인**
      - 2개의 무한데이터 소스를 조인할 때 시간적인 요소를 고려할 필요 없음
  - 근사 처리(approximation)
    - 낮은 오버헤드지만 알고리즘이 복잡.
      - Top-N
      - 스트리밍 k 평균
    - 시간적인 요소는 도착하는 시간인 처리 시간을 기준으로 이루어짐
    - 증명 가능한 오차 범위를 제공하는 것이 중요
    - 본질적으로는 시간 무시와 비슷하여 현대에서는 관심이 덜함
  - **처리 시간 윈도우(processing time window)**
    - ![3가지 윈도우](https://www.oreilly.com/radar/wp-content/uploads/sites/3/2020/02/Figure-03-Windowing.jpg)
      - 고정 윈도우(fixed, tumbling)
        - 시간을 고정된 크기로 자름
        - 비정렬 윈도우 형태를 가짐
      - 슬라이딩 윈도우(sliding, hopping)
        - 윈도우간의 겹치는 부분이 발생(고정 윈도우보다 주기가 짧음)
        - 성능을 위하면 비정렬도 가능하지만, 보통은 정렬 윈도우 형태를 가짐
      - 세션(session)
        - 동적 윈도우
        - 연속된 이벤트를 묶어서 윈도우를 구성
        - 사용자의 행동 분석을 위해 사용
        - 길이가 가변적임
        - 비정렬 윈도우
    - 어느 정도의 처리시간이 지날 때까지는 데이터를 버퍼링함.
    - 데이터를 셔플링할 필요가 없어 단순함
    - 윈도우가 완료되는 시점 판단 쉬움
    - 관측되는 시점을 기준으로 정보를 추론할 때 적합 ex) 초당 요청 개수 모니터링
    - **이벤트 순서는 보장되지 않음** ex) 모바일 기기 오프라인 -> 온라인
  - **이벤트 시간윈도우(event time window)**
    - 이벤트가 실제 발생한 시간을 반영해 유한한 크기의 조각으로 데이터 소스를 관찰
    - 이벤트 시간을 기준으로 하기 때문에 다른 처리 시간의 윈도우에 도착할 수 도 있음
    - 세션 같은 동적인 크기를 갖는 윈도우 만들 때 유용
    - 버퍼링
      - 윈도우의 수명이 길어져서 데이터를 버퍼링할 필요 생김
      - persistent storage는 리소스 가격이 저렴한 축에 속하나, 영구적인 상태 보존과 데이터 처리 시스템을 잘 설계해야함
      - 중간 데이터를 사용함으로써 점진적으로 결과를 낼 수 있음
    - 완결성
      - 데이터를 언제 볼 수 있는지 미리 알 수 없음
      - 워터마크를 사용할 수 있으나 정확한 완결성은 보장 X
      - 윈도우 결과를 언제 구체화할지 그 결과가 시간에 따라 어떻게 정제될 지 표현하는게 최선

---

### 요약

- 스트리밍 정의
- 배치 및 스트리밍 시스템의 비교. 배치가 스트리밍의 부분 집합임을 강조
- 스트리밍은 배치를 뛰어넘기 위해 정확성과 시간 판단도구를 제안
- 이벤트 시간 vs 처리 시간
- 데이터 처리 패턴 4가지 접근법
