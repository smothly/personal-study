# 네트워크의 공통 언어 TCP/IP

---

## 3-1 TCP/IP
- PC도 스마트폰도 서버도 TCP/IP를 사용한다.
  - TCP/IP는 TCP와 IP를 중심으로 하는 프로토콜의 집합.
  - 네트워크의 공통 언어.
  - TCP/IP로 통신하는 각종 PC 스마트폰 네트워크 기기 등을 **호스트**라고 칭함
- TCP/IP의 계층 구조
  - 4계층
    - 어플리케이션층: 어플리케이션에서 다룰 데이터 형식과 절차를 결정(HTTP, SMTP DNS 등)
    - 트랜스포트층: 어플리케이션에 데이터를 할당(TCP/UDP)
    - 인터넷층: End to End 통신(IP, ICMP, ARP 등)
    - 네트워크 인터페이스층: 프로토콜 선택 (이더넷, 무선 LAN 등)
  - OSI 7Layer vs TCP/IP 4Layer
    - ![OSI 7Layer vs TCP/IP 4Layer](https://raonctf.com/static/essential/images/network/network_layer_02.jpg)

---

## 3-2 네트워크 인터페이스층과 인터넷층
- 네트워크 인터페이스층
  - 같은 네트워크 안에서 데이터를 전송하는 역할
  - 기술적인 관점에서 하나의 네트워크는 라우터와 레이어3 스위치로 구획되는 범위, 또는 레이어2 스위치로 구성하는 범위
  - 프로토콜로는 유선(이더넷)이나 무선 LAN(wi-fi), PPP 등을 들 수 있음.
  - 상대방과 네트워크 인터페이스층의 프로토콜이 같을 필요는 없음
- 인터넷 층
  - 네트워크 사이에서 데이터를 전송하는 역할
  - 연결하고 데이터를 전송하는 기기 = 라우터
  - 최종적인 출발지와 목적지 사이의 데이터 전송 = **엔드투엔드 통신**
  - 프로토콜로는 IP, ICMP, ARP 등이 있고, IP가 엔드투엔드 통신에 사용되며 ICMP와 ARP는 IP를 도와주는 프로토콜
  
---

## 3-3 트랜스포트층과 어플리케이션층
- 트랜스포트층
  - 데이터를 적절한 어플리케이션에 배분하는 역할
  - 프로토콜은 TCP와 UDP
    - TCP는 엔드투엔드의 신뢰성을 확보해 주는 기능
    - 데이터 분할과 조립등도 함
- 어플리케이션층
  - 어플리케이션 기능을 실행하기 위한 데이터의 형식과 처리 절차등을 결정하는 역할
  - 0과1의 디지털 데이터를 사용자가 이해할 수 있는 TEXT, IMAGE등으로 바꾼다
  - 프로토콜은 HTTP, SMTP, POP3, DHCP, DNS 등

---

## 3-4 캡슐화
- 프로토콜의 제어정보 '헤더'
  - TCP/IP에서는 4개의 프로토콜을 조합
  - 각각의 기능을 실현할려면 제어 정보(= 헤더) 가 필요
  - 헤더를 추가하는 처리를 **캡슐화** 라고 함
  - 프로토콜 헤더를 적절하게 처리하여 헤더를 벗겨내고 다른 프로토콜로 처리를 넘김(역캡슐화, 비캡슐화)
- 물리적인 신호 변환
  - 클라이언트가 웹서버로 통신하는 예시
    1. 웹브라우저의 데이터는 HTTP헤더로 캡슐화 후 TCP로 전송
    2. TCP헤더 추가
    3. IP 헤더 추가
    4. 이더넷 헤더와 FCS(Frame Check Sequence)추가
    - 상위 -> 하위 계층으로 헤더가 캡슐화 되면서 여러 프로토콜의 헤더가 추가됨
    - 마지막으로는 캡슐화된 데이터를 물리적인 신호로 변환해 전송 매체로 내보냄
    - ![캡슐화 과정](https://www.researchgate.net/profile/Isara_Anantavrasilp/publication/49288737/figure/fig4/AS:669528941924353@1536639547060/Packet-encapsulation-TCP-IP-architecture-encapsulates-the-data-from-the-upper-layer-by.png)

---

## 3-5 TCP/IP를 이용한 통신
- 0과 1의 데이터
  - 네트워크 기기는 수신한 물리적인 신호를 일단 0과1의 데이터로 되돌림
  - 헤더를 참조해며 데이터를 전송해감
- 헤더로 목적지 확인하고 수신
  - 역캡슐화 과정으로 헤더를 처리함
  - TCP헤더에서 어느 어플리케이션의 데이터인지 확인
  - HTTP에서는 이진화된 데이터를 처리

---

## 3-6 메시지, 세그먼트, 패킷, 프레임
- 계층별로 데이터를 부르는 방법
  - 어플리케이션층: 메시지
  - 트랜스포트층: 세그먼트(TCP) or 데이터그램(UDP)
  - 인터넷층: 패킹 or 다이어그램
  - 네트워크 인터페이스층: 프레임
- 데이터 부르는 방법 예시
  1. HTTP헤더 추가하면 HTTP 메시지
  2. TCP헤더 추가하면 TCP 세그먼트
  3. IP헤더 추가하면 IP 패킷
  4. 이더넷 헤더와 FCS 추가하면 이더넷 프레임
  - 레이어 2 스위치는 네트워크 인터페이스층에 동작하는 네트워크 기기여서 프레임을 전송하는 역할
  - ![각 계층에 따른 네이밍](https://images.slideplayer.com/39/10948607/slides/slide_5.jpg)

---

## 3-7 IP, IP패킷, 라우팅
- IP란?
  - Internet Protocol
  - 엔드 투 엔드 통신하는 역할
  - A -> B로 데이터 전송하는 것이 IP의 역할
- IP 패킷
  - IP 헤더를 추가해 IP 패킷으로 만듬
  - IP 헤더에서 제일 중요한 것은 **IP 주소**
  - 목적지가 다른 네트워크에 접속된 경우는 중간에 라우터가 존재
  - 라우터가 IP 패킷을 전송하는 것 = 라우팅
  - ![IP 헤더 포맷](https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/IPv4_Packet-en.svg/1200px-IPv4_Packet-en.svg.png)

---

## 3-8 IP 주소
- IP 주소 개요
  - TCP/IP에서 통신 상대의 호스트를 식별하기 위한 식별 정보
  - IP패킷을 만들 때 IP 헤더에 출발지와 목적지 IP 지정
- 인터페이스에 IP 주소를 설정
  - 호스트 내부에서 인터페이스와 IP의 프로토콜 부분을 연관지어 IP 주소를 설정하게 됨
  - IP주소는 호스트 자체가 아니라 정확하게는 호스트의 인터페이스를 식별함
- IP 주소 표기
  - 32비트
  - 8비트씩 10진수로 변환하여 .으로 구분하여 표기 = 도트형 10진수 표기
  - 0~255 4자리수를 .으로 4개
  - ex) 192.168.1.1 = 11000000/10101000/00000001/00000001
  - ![IP주소 예시](https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Ipv4_address.svg/750px-Ipv4_address.svg.png)


---

## 3-9 유니캐스트, 브로드캐스트, 멀티캐스트

- IP로 데이터를 전송할 때, 목적지는 몇 개이든 상관 없음.
- IP 헤더에 목적지에 따라 아래 3가지의 IP를 추가함
  - 유니캐스트
    - 한 곳으로 데이터를 전송
    - 복수의 곳으로 데이트를 전송하기 위해서 유니캐스트를 반복하여도 되지만, 효율이 좋지 않음
  - 브로드 캐스트
    - 같은 네트워크 상의 모든 호스트에 완전히 똑같은 데이터를 전송
  - 멀티캐스트
    - 특정 그룹에 포함되는 호스트에 완전히 똑같은 데이터를 전송

---

## 3-10 유니캐스트 IP 주소
- 유니캐스트 IP 주소의 구성
  - TCP/IP 통신의 대부분은 유니캐스트
  - IP주소는 네트워크부 / 호스트부 두 부분으로 구성
    - **네트워크부**는 네트워크(레이어3 스위치와 라우터로 구성된 복수의 네트워크 중 하나)를 식별
    - **호스트부**는 네트워크 내 호스트(의 인터페이스)를 식별
- 브로드캐스트 IP 주소
  - 32비트가 모두 1인 IP 주소 = 255.255.255.255
  - 같은 네트워크에 있는 모든 호스트에 일괄적으로 데이터를 전송
- 멀티캐스트 IP 주소
  - 224.0.0.0 ~ 239.255.255.255 로 범위가 정해져 있음
  - '224.0.0.2 = 같은 네트워크 상의 모든 라우터' 처럼 미리 정의되어 있는 멀티 캐스트 IP 가 있음
  - 239로 시작되는 범위는 사용자가 그룹을 자유롭게 정의 가능
  
---

## 3-11 서브넷 마스크
-  서브넷 마스크란?
  - 네트워크부와 호스트부의 구분은 고정이 아니라 가변적
  - 어디까지가 네트워크부인지 명시한 것이 **서브넷 마스크**
  - 32bit로 1은 네트워크부 0은 호스트부를 나타냄
  - 서브넷 마스크는 연속한 1과 연속한 0으로 나옴
  - / 뒤에 연속한 1의 개수로 표기하는 방식을 프리픽스 표기라고 함 ex) 192.168.1.1/24
  - 102.168.1.1 255.255.255.0 = 192.168.1.1/24
- 네트워크 주소와 브로드캐스트 주소
  - 호스트부를 모두 비트 0으로 채우면 네트워크 자체를 식별하기 위한 **네트워크 주소**가 됨
  - 호스트부를 모두 비트 1로 채우면 **브로드캐스트 주소**가 됨

---

## 3-12 IP 주소 설정
- 물리적인 접속과 논리적인 접속
  - **물리적인 접속**
    - 네트워크 인터페이스층
    - 물리적인 신호를 주고받게 하는 것
    - 이더넷의 인터페이스에 LAN 케이블 삽입, 무선 LAN 액세스 포인터에 접속 하는 등의 일
  - **논리적은 접속**
    - 인터넷층
    - 인터페이스에 IP 주소를 설정하는 것
    - 물리적으로 접속이 이루어진 후 논리적인 접속으로서 IP 주소 설정도 필요
    - DHCP등의 기술로 자동으로 설정

---

## 3-13 공인 주소, 사설 주소
- IP 주소의 이용 범위
  - 공인 IP 주소(퍼블릭)와 사설 IP 주소(프라이빗) 2가지로 분류
  - 공인 IP
    - 인터넷에서 이용하는 IP 주소
    - 인터넷 전체에서 중복되지 않게 관리
    - 퍼블릭 주소 또는 글로벌 주소라고도 불름
  - 사설 IP
    - 사설 네트워크에서 이용하는 IP 주소
    - 아래 범위의 주소는 사설 네트워크 안이라면 자유롭게 이용 가능
      - 10.0.0.0 ~ 10.255.255.255
      - 172.16.0.0 ~ 172.31.255.255
      - 192.168.0.0 ~ 192.168.255.255
- 사설 네트워크에서 인터넷으로의 통신
  - 사설 네트워크에서 인터넷으로 통신할려면 **NAT(Network Address Translation)**이 필요

---

## 3-14 NAT
- 사설 주소 응답
  - 출발지가 사설 네트워크고 목적지가 공인 IP면 요청은 문제 없이 보낼 수 있음
  - 반대로, 출발지가 공인 네트워크이면 응답을 받지 못함
  - 목적지가 사설 주소로 된 IP 패킷은 폐기함
- 주소 변환
  - 사설 네트워크에서 인터넷으로 통시낳기 위해서는 NAT로 주소를 변환
    - 출발지 IP 주소를 변환
    - 라우터는 '기존 IP : 변환한 IP'를 NAT 테이블에 보존
    - 응답이 라우터로 돌아오면 목적지 IP 주소를 NAT 테이블을 보고 변환 
    - 복수의 사설 주소를 하나의 글로벌 주소에 대응시키는 주소변환은 **NAPT(Network Address Port Translation)**라고 함

---

## 3-15 ICMP
- IP 확인
  - IP를 목적지에 도달했는지에 대한 여부를 응답 받기 전까지 모름
  - '데이터를 보내기 위해 최선을 다했지만 어쩔 수 없지' 라는 것이 IP의 특징 = best effort
  - 그래서 별도의 엔드투엔드 통신이 정상적으로 이루어 져있는지 확인하는 기능을 갖춘 프로토콜로서 **ICMP(Internet Control Message Protocol)**를 개발
- ICMP의 기능
  - 주요 기능
    - 에러 리포트
      - IP 패킷이 폐기됐다면 출발지로 실패한 원인을 담아 **도달불능 메시지**를 보냄
    - 진단 기능
      - 엔드투엔드 통신이 가능한지 확인하는 기능 ex) ping 커맨드

---

## 3-16 ARP
- ARP란?
  - Address Resolution Protocol
  - PC나 서버등의 인터페스는 MAC주소로 식별
  - TCP/IP의 IP주소와 인터페이스를 식별하기 위한 MAC 주소를 대응시키는 것이 **ARP**의 역할
  - 이더넷 헤더에 목적지 MAC 주소를 지정해야함
  - 목적지 IP 주소에 해당하는 MAC 주소를 구하기 위해 ARP를 사용
  - IP 주소와 MAC 주소를 대응시키는 것을 가리켜 **주소해석**이라고 함.
- ARP 동작의 흐름
  - 주소 해석 범위는 같은 네트워크 내의 IP 주소
  - 이더넷 인터페이스로 접속된 기기가 목적지 IP주소를 지정할 때 ARP가 자동으로 수행됨
  1. ARP요청으로 IP 주소에 대응하는 MAC 주소를 질의
  2. 호스트가 ARP 응답으로 MAC 주소를 알려줌
  3. 주소 해석한 IP 주소와 MAC 주소의 대응을 ARP 캐시에 보존
  - ![ARP예시](https://marvel-b1-cdn.bc0a.com/f00000000216283/www.fortinet.com/content/fortinet-com/en_us/resources/cyberglossary/what-is-arp/_jcr_content/par/c05_container_copy_c/par/c28_image_copy_copy_.img.jpg/1625683953964.jpg)

---

## 3-17 포트 번호, 웰노운 포트 번호
- 포트 번호의 역할
  - 호스트에서 동작하는 어플리케이션에 데이터를 배분하기 위해서는 각각의 어플리케이션을 식별할 수 있어야 함 => 포트 번호를 이용
  - TCP 또는 UDP 헤더에 지정함.
  - 16비트 수치, 0~65535 점위
- 포트 번호의 구분
  - 웰노운 포트 번호
    - well known port
    - 서버 어플리케이션을 실행하면 클라이언트의 요청으로 부터 기다리는 예약된 포트번호
  - 등록된 포트
    - registered port
    - 자주 이용되는 서버 어플리케이션 식별
  - 동적/사설 포트 번호
    - 클라이언트 어플리케이션 식별 
    - 정해져 있지 않고 동적으로 할당됨
  - ![포트번호 구분](https://blog.kakaocdn.net/dn/bFRr4e/btqOxrakG3N/tlFiyXYbG3O3IjIK4T7ET1/img.png)

---

## 3-18 TCP
- TCP란?
  - 어플리케이션간 신뢰성이 있는 데이터 전송
- TCP 데이터 전송 절차  
  1. TCP 커넥션 맺기
     - 어플리케이션간 통신이 정상적으로 이루어졌는지 확인함 = 3-way handshake
  2. 어플리케이션 간 데이터 송수신
    - 어플리케이션의 데이터에 어플리케이션 프로토콜 헤더와 TCP 허더를 추가 해야함 = TCP 세그먼트
    - 만약에 TCP 세그먼트가 크면 복수의 TCP 세그먼트로 전송
    - 어떻게 분할했는지는 TCP 헤더에 기술대고 목적지에서 원본 데이터로 조립됨
    - 데이터 수신 확인(ACK) 데이터가 제대로 도착하지 않으면 재전송
    - 네트워크가 혼잡하면 데이터 전송 속도를 제한함  = 플로우 제어
  3. TCP 커넥션 끊기