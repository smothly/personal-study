# 메타데이터 계층 아키텍처

## 7.1 메타데이터의 의미

---

- 다른 **데이터에 대한 정보를 제공하고 설명하는 데이터**의 집합
- 비즈니스 메타데이터와 데이터 플랫폼 내부 메타 데이터(파이프라인 메타데이터)

### 비즈니스 메타데이터

- 데이터의 생성 일자, 발생 조직, 소유자, 크기, 용도 등의 태그를 말함
- 데이터에 대한 배경을 이해하는데 중요하고 검색도 쉬워야 함
- 각 클라우드도 데이터 카탈로그 서비스들을 가지고 있음

### 파이프라인 메타데이터

- 데이터 소스 목록과 데이터 소스에 대한 상세 정보, 파이프라인 수행 정보
- 자동화, 모니터링, 설정 관리시 필수 요소

## 7.2 파이프라인 메타데이터의 장점

---

- FTP -> 파이프라인(간단한 데이터 검증) -> DW의 작업은 쉬움. 메타데이터 관리도 쉬움. 원인 파악도 쉬움
- 하지만, 실제로는 소스가 추가되고 파이프라인이 복잡해짐. 이 때도 기존의 파이프라인을 활용할 수 있을까?
  - 만약 데이터가 지연된다면 원인파악을 각 단계마다 수행해야 함
- **설정 방식의 파이프라인** 
  - 파이프라인을 매번 중복하여 관리하면 안됨
  - 데이터 소스와 시스템마다 별도의 파이프라인이 아닌 하나의 파이프라인 코드로 구성
  - 데이터 소스와 시스템 정보 같은 것은 설정값 형태로 관리
  - 파이프라인 코드, 외부 설정값이 분리되어야 함. 코드변경 없이 설정값만 변경하면 돌아가는 형태
  - 데이터 소스가 달라지더라도 잘 구현된 인터페이스 하나로 확장할 수 있도록!
- **메타데이터의 세 가지 주요 기능**
  - 모든 파이프라인의 설정 정보 관리
  - 각 파이프라인의 실행 상태와 통계 정보
  - 스키마 저장소
- 메타데이터 사용은 인터페이스가 되어야 함
- 예시
  - FTP 소스 위치가 변경되면 설정값 변경하는 식으로
  - 특정 변환 파이프라인의 장애시 메타데이터 계층을 통해 알람 받고 상태 정보를 메타데이터를 통해 확인
  - 장애, 데이터 속도, 경고 메커니즘, 스트림 중복 항목 수
  - 파이프라인의 입출력 정보
  
## 7.3 메타데이터 모델

---

- 표준이 없음

### 메타데이터 도메인

- 4가지
  - ![a](https://drek4537l1klr.cloudfront.net/zburivsky/Figures/CH07_F04_Zburivsky.png)
  - 파이프라인 메타데이터
    - source target 정보, 수집 파이프라인 정보, 변환 파이프라인 정보 등 설정 값
    - 2개의 도메인을 가진 데이터 예시
    - 파이프라인 속성
      - ID
      - 이름
      - 설명
      - 유형 - 수집인지 변환인지
      - 속도 - 배치인지 실시간인지
      - 소스와 데스티네이션 - 매핑 정보
      - 데이터 품질 검사 ID - 품질 검사 목록
      - 생성 타임스탬프
      - 수정 타임스탬프
      - 연결 세부 정보
  - 파이프라인 처리 내역
    - 파이프라인 실행 내역 추적, 처리 데이터 양
    - 트러블 슈팅하는 데 활용
    - 파이프라인 메타데이터로 수집하기
    - 속성
      - 처리 내역 ID
      - 파이프라인 ID
      - 시작 시간
      - 종료 시간
      - 상태
      - 오류 메시지
      - 소스 및 데스티 네이션 ID
      - 읽은 행 수
      - 저장한 행 수
      - 읽은 바이트 수
      - 저장한 바이트 수
      - 추가 속성들 - export간격, 스토리지 경로, 토픽 정보
    - 실시간 데이터의 경우도 비슷하게 하면 되게 시작/종료 시간 대신 윈도우별 정보로 하면 됨
    - 왜 필요한지? 작업 가시성을 높이기 위해!
      - 성공중에 가장 최근 완료 시점
      - 평균 실행 시간
      - 평균 처리 건수
      - 매일 수집되는 데이터 양
  - 데이터 품질 검사
    - 품질 검사 정보, 품질 검사 파이프라인
    - 정의된 파라미터에 부합되지 않는 데이터의 식별
    - proactive(예방)
      - NULL값 점검, 유효성 점검, 컬럼 형식 준수 등
      - 수집 파이프라인에서 수행되며 데이터 플랫폼으로 들어오지 않음
      - 컬럼단위나 행단위로 진행 됨
    - retrospective(후향)
      - 논리적 무결성과 일관성을 유지하는지
      - 일종의 데이터 변환 파이프라인이라고 봐도 됨
    - DSL을 사용하여 직접 구현하는 곳도 있고, SQL기반으로 구현하는 경우도 있음
      - 데이터 품질 메타데이터
        - ID
        - 이름
        - 심각도
        - 규칙 - 검사 로직
        - 타임스탬프
  - 스키마 레지스트리
    - namesapce(도메인)
      - id
      - 설명
      - 생성 시간
      - 수정 시간
    - source target 스키마 정보
      - 소스 속성
      - ID
      - 이름
      - 스키마 ID - 스키마 레지스트리 링크
      - 데이터 품질 검사
      - 유형 - 테이블, 파일, 토픽
      - 최종 수정 타임스탬프
    - 타겟 속성
      - 소스와 동일

## 7.4 메타데이터 계층 구현 옵션

---

- 어떻게 구현해야 하는가?!

### 설정 파일의 모음인 메타데이터 계층

- 설정 파일 방식을 활용하기
  - 설정 파일이 변경되면 CI/CD가 가동돼 클라우드 스토리지에 저장되도록 하기
  - 저장된 파일을 수집/변환 파이프라인에서 읽어서 사용하기
  - 파이프라인을 거치고 나온 로그는 로그 집계 서비스에서 활용

  ```yaml
  ---
  namespaces:
  sales:
    id: 1234
    description: This namespace contains data from sales data sources
    created_at: 2020-03-10 08:17:52
    modified_at: 2020-03-15 14:23:05
  hr: 
    id: 1235
    description: This namespace contains sensitive data from HR data sources.
    created_at: 2020-03-01 10:08:40
    modified_at: 2020-03-01 10:08:40
  ```

  - ![메타데이터 CI/CD예시](https://drek4537l1klr.cloudfront.net/zburivsky/Figures/CH07_F10_Zburivsky.png)
  - 실시간 파이프라인의 경우 주기적으로 체크 하도록 구현해야 함
  - 파이프라인 동작의 메타데이터로는 정적이여서 설정 파일을 통해 활용하기 좋음
- 로그 집계서비스 활용하기
  - 처리 내역 메타데이터는 동적임
  - 로깅을 추가하는 것은 어렵지 않으나 집계하는 것이 어려움
  - 아래와 같은 로깅 분석 툴을 사용할 것
    - azure monitor, cloud logging, elasticsearch

### 메타데이터 데이터 베이스

- 설정 데이터를 관리하기에는 메타데이터의 구조가 계속 추가/변경 되기 때문에 `document db` 가 좋음
- 쿼리형식으로 질의할 수 있기 때문에 설정파일을 파싱하여 DB에 저장하는 것이 효율적임

### 메타데이터 API

- 대규모 단위를 한 메타디비로 관리하게 되면 접근관리나 운영의 불편함이 있음
- API를 접근하도록 하면, 디비에 대한 종속성이 많이 사라짐
- 규모에 따라 파일 -> DB -> API로 가면서 상황에 맞는 메타데이터 활용을 구축할 것

![메타데이터 API](https://drek4537l1klr.cloudfront.net/zburivsky/Figures/CH07_F12_Zburivsky.png)

## 7.5 기존 솔루션 개요

---

### 클라우드 메타데이터 서비스

- AWS Glue Catalog
  - source/target 정보
  - 파이프라인 실행 내역 정좁
  - 기타 통계 정보
  - API 방식 제공하며 schema registry역할도 함
  - crawler
    - 스키마 스캔 및 메타데이터 관리
  - 테이블별 HWM, 마지막으로 처리된 파일 등을 Job bookmark로 관리함
  - 처리된 행은 job 통계정보로 관리
  - 한계점
    - 유연성: glue에서 지원하지 않는 소스들은 따로 관리해야 함
- azure와 gcp는 데이터 카탈로그를 주로 지원함
  - 데이터가 어디 있는지 쉽게 검색해주는 서비스
  - self 분석에 가장 도움이 되는 서비스
  - DW와 데이터 소비자 사이에 들어가는 부수 계층

### 오픈 소스 메타데이터 계층

- apache atlas
  - type/entity라는 개념을 지원함
  - 타입끼리 링크를 걸 수 있음
  - 타입에 맞는 속성들이 정의되어 있음
  - API도 제공함
  - 하둡 플랫폼과 함께 동작하도록 만들어짐
  - hive, Solr 시스템이 추가로 필요
- datahub
  - 메타데이터 검색할 때 좋음
  - 메타데이터 수집을 위해 카프카 클러스터가 필요
  - ES + Neo4j로 검색기능 제공
  - 운영 오버헤드 필요
- marquez
  - 파이프라인 정보를 수집 및 추적
  - 데이터 리니지를 파악할 때 좋음
  - 메타데이터 검색으로 사용하기에는 신규 엔터티 추가가 어려움

## 요약

---

- 비즈니스 메타데이터와 파이프라인 메타데이터(데이터 플랫폼 메타데이터)가 있음
- 파이프라인 메타데이터
  - 데이터 파이프라인 관리 목적
  - 자동화, 모니터링, 설정 관리 에 필수적
  - 설정 관리와 실행 및 처리 정보를 저장하는 2가지 유형으로 나뉨
- 메타데이터 계층 3가지 역할
  - 파이프라인 설정관리를 위한 공통 스토리지
  - 파이프라인 상태와 통계 추적
  - 스키마 저장소
- 메타데이터 4가지 그룹
  - 파이프라인 메타데이터(설정)
  - 파이프라인 처리 내역들(activities)
  - 데이터 품질 검사
  - 스키마 레지스트리
- 파이프라인 코드 수정 없이 설정파일으로만 관리되도록 하고 파이프라인 통계를 통해 장애 파악
- 인터페이스가 되어라!
- 메타데이터는 저장소 -> NoSQL DB -> API 중 형태에 맞는 저장소 사용할 것
- 메타데이터 솔루션들을 잘 조합해서 활용해 볼 것
