# 스토리지

- s3의 버전 관리, 스토리지 클래스, 전송가속화

---

## 8-1 더 스마트한 스토리지

### 버전 관리

- 개체에 대한 버전 관리가 됨
- 버저닝 옵션을 활성화 하면 됨. but, 비용 증가

### 정적 웹사이트 호스팅하기

- 버킷정책을 모든사람에 대해 허용
- index html 정해줘야함
- 맞춤 도메인을 할려면 route53을 통한 DNS설정

### 스토리지 클래스

- standard
  - 기본 스토리지 클래스
  - 저장비용: GB당 $0.03
- standatd_ia
  - 자주 액세스하지 않는 데이터
  - 10,000건의 요청당 $0.01 (standard는 0.004)
  - 저장비용: GB당 $0.0125
- GLACIER
  - 백업데이터 용도
  - 처음부터 glacier로 생성은 불가
  - 저장비용: GB당 $0.007
- REDUCED REDUNDANCY
  - 중복성이 적음
  - 99.99%의 내구성
  - 쉽게 재생성할 수 있는 데이터들에 유용
  - 저장비용: GB당 $0.024

### 객체 수명주기 관리

- 30일 이후에 IA 클래스로 가도록 설정

### 전송 가속화

- cloudfront의 분산엣지 로케이션을 사용해 파일을 더 빨리 업로드
- 전 세계 사용자가 중앙버킷에 업로드하거나 타 대륙으로 데이터를 전송하는 경우 유용
- GB당 $0.04 ~ $0.08

### 이벤트 알림

- 3가지 이벤트에 대한 알림설정
  - 새 객체가 생성되는 시점
  - 객체가 삭제되거나 버전관리의 경우 삭제 마커 생성시점
  - RRS 객체의 손실 시점
- 이벤트 대상
  - sqs
  - sns
  - lambda

---

## 8.2 안전한 업로드

### 아키텍처

- 인증된 사용자만 로드할 수 있도록 변경
  - 업로드 관련 정보 및 조건
  - 새 파일을 만들 권한이 있는 IAM 사용자의 비밀 엑세스 키를 사용해 구성된 HMAC 서명
  - 서명에 사용된 액세스키 ID와 비밀키
  - 업로드 대상파일
- 업로드하는 자격증명을 생성하는 새 람다를 만듬

### Lambda의 업로드 정책

- 단계
  1. 서명을 생성할 IAM 사용자 생성
  - s3 업로드 policy 생성
  2. 람다 함수 구현
  - 임시자격증명 정책을 만드는 코드
  - crypto를 사용하여 IAM 사용자의 비밀키를 사용해 HMAC 서명을 만듬
  - 파일이름은 16진수로 중복 X
  - 최종 아웃풋
    - signature
    - encoded policy
    - access_key
    - upload_url
    - key
  3. API Gateway
  - 2번에서 만든 람다를 POST로 연결
  - CORS enable
  - 사용자 정의 권한 모듈 함수를 authorization으로 등록

### s3 cors 설정

- origin / header / method 설정
  
### 웹 사이트에서 업로드 하기

- 버튼 만들어 위의 엔드포인트 바라보도록 설정

---

## 8.3 파일 접근 제한

- 비디오 파일 버킷에 대해 익명 및 공개 접근 비활성화
- 권한이 부여된 사용자를 위해 제한 시간이 있는 URL 생성

### 공개된 접근 제한

- 권한을 전부 all users 제거

### 서명된 URL 생성하기

- filename을 통한 전체 URL 로 변경
- expire시간 설정가능

---

## 연습문제

- 데이터 전송 가속화 설정
- 객체 수명주기 관리 구현
- 업로드 자격 증명
- s3 정적 웹 호스팅
- 서명 URL 24시간으로 변경
- CORS에 필요한 헤더만 지정
- 공개 및 비공개 동영상만들기
- 모든 버킷의 권한을 한꺼번에 변경
  
---

## 요약

- 스토리지 클래스
- 버전 관리
- 전송 가속
- 정적 웹사이트 호스팅
- 객체 수명주기 규칙
- 이벤트 알림
