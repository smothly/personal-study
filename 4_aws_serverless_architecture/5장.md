# 5장 인증과 권한

- Cognito(AWS)와 Auth0(not AWS)
- API Gateway를 사용해 API개발
- API 보호 방법

---

## 서버리스 환경에서의 인증

- 토큰 위임과 같은 기술

### 서버리스 방식

- JWT(Json Web Token)를 사용
  - JWT의 클레임은 JWS(Json Web Signature) 구조의 페이로드 또는 JWE(Json Web Encryption) 구조의 JSON 객체로 인코딩 됨
  - 클레임을 MAC(Message Athentication Code)으로 디지털 서명을 하거나 무결성을 보호하거나 암호화할 수 있음
- 필수 정보를 캡슐화 할 수 있음.
- API Gateway에서 토큰의 유효성 검사
- Lambda또는 Auth0를 사용하여 위임토큰 만들기
- 아키텍처(인증 과정)
    1. 클라이언트가 인증서비스를 사용한 로그인 요청
    2. 인증서비스로부터 Json 웹토큰 반환
    3. 클라이언트가 위임토큰을 데이터 베이스에 기록
    4. 위임토큰을 가지고 API Gateway에 요청
    5. 타사 서비스에서 데이터베이스 자격 증명을 조회
    6. 조회된 자격증명을 사용해 데이터베이스에 기록

### Amazon Cognito

- 전체 등록 및 로그인 시스템 구축, 공개 자격증명 공급자 또는 기존의 인증 프로세스와 통합할 수 있음
- 인증되지 않은 사용자는 IAM 역할 또는 임시 자격증명이 할당 됨
- 최종 사용자 데이터 저장 가능
- 비밀번호 재설정이나 TouchID와 같은 일부 고급 기능에 제한. 그럴땐 Auth0

### Auth0

- 범용 자격증명 플랫폼
- AWS와 통합성 측면에서 좋음

---

## 24-Hour Video에 인증 추가

- Auth0를 사용하여 인증 처리

### 계획

1. 기본 웹사이트 생성
2. Auth0에 어플리케이션 등록하고 웹 사이트에 통합 (JWT 반환)
3. API Gateway + Lambda
4. JWT를 디코딩하고 Auth0 엔드포인트 호출하여 사용자에 대한 정보를 얻음

### Lambda를 직접 호출

- SDK를 사용하여 호출할 경우, 요청제한이나 응답캐시 등의 작업이 어려움
- API 게이트웨이를 사용하면 HTTP 통신 규칙등을 사용하는 restful 인터페이스 구축 가능

### 웹 사이트 구축

- 초기 구축하는 웹사이트 다운받아 package.json에 추가

### Auth0구성

- Auth0 서비스 들어가 가입 및 설정
- SPA + 콜백URL에 localhost 추가
- 계정 연결도 가능하나 여기서는 패스
- 자격증명 제공자를 클릭하면 API 키와 같은 정보들이 필요. 무료버전은 2개까지 가능
- 여기서 제공받은 토큰은 Authorization 헤더에 계속 전송
- Auth0 Lock은 로그인/가입 대화상자 제공하는 무료 위젯
  - Auth0 Lock 추가
  - 로그인, 로그아웃, 사용자 프로필 버튼 추가
  - JWT 토큰을 저장하기 위한 자바스크립트 코드 추가

### Full test

- 로그아웃하여 JWT 제거하고 진행

---

## AWS와 통합

- 위에 까지 한 방법은 브라우저에서 바로 JWT 권한을 받는 방식
- API Gateway를 통해 Lambda로 인증을 진행

### 사용자 프로필 Lambda

- IAM 역할 생성
- Lambda의 역할
  - JWT 검증
  - Auth0를 통한 사용자 정보 조회
  - 웹 사이트에 응답
- 환경변수를 통해 auth0 secret과 domain을 가져옴

### API Gateway

- GET메소드와 CORS 활성화
- user-profile 람다와 연결

### 매핑

- json으로 매핑해줌
- 프록시 통합은 HTTP 요청이 이벤트 객체로 사용할 수 있게 해줌
- 배포

### API Gateway를 통한 Lambda 호출

- get요청으로 api gateway url 호출

### 사용자 정의 권한 모듈

- 요청의 권한을 확인
- Lambda까지 닿기전에 체크함
- 사용자 정의 권한 모듈을 사용하면 JWT 검증 전용 Lambda를 작성할 수 있음
- IAM 정책이 반환됨
- 모든 요청에 권한 확인하기에 유용

---

## 위임 토큰

- 위임토큰은 서비스 통합을 할 때 쓰임, 한 서비스가 다른 서비스(API)를 호출하기 위해 작성한 토큰

### 실제 사례

- Firebase에서 사용
- 클라이언트에 요청에 위임 토큰이 포함되어 있으면 토큰 확인 가능
- Auto0에 firebase비밀키 사용하여 위임 토큰 사용할 수 있음

### 위임 토큰 프로 비저닝

- Auth0의 경우 서비스의 추가 기능을 구성한 다음, 위임 토큰을 요청

---

## 연습문제 및 요약

- Lambda함수 사용자 정보 로깅
- POST 메소드로 변경
- update하는 함수도 만들기
- front에서 토큰값을 설정하여 보안 강화
- auth0추가기능 서비스를 통해 토큰 처리하는 람다 함수 필요성 감소
- 다른 소셜 추가
- 오류 메시지를 표시하지 않고 만료된 토큰 자동으로 삭제
