# 7장 API Gateway

- API를 구축하고 관리하기 위한 스테이징 및 버전 관리
- 요청에 대한 캐싱과 로깅 스로틀링

---

## 인터페이스 역할을 하는 API 게이트웨이

### AWS 서비스와의 통합

- HTTP 프록시
  - 다른 HTTP 엔드포인트로 전달
  - 메소드는 기본적인 것은 전부 지원
  - 레거시 API앞에 사용하거나, 요청을 변경 및 수정할때 유용
- AWS 서비스 프록시
  - AWS 서비스를 직접 호출
  - 람다 함수를 직접 만드는 것보다 직접 프록시하는 방법이 빠름
  - 고급 사용사례에서는 함수를 작성해야함
- 목 통합
  - Mock옵션은 API Gateway에서 응답을 생성하는 데 사용
  - CORS에 의한 사전 전달에 대한 응답의 경우

### 캐싱, 스로틀링, 로깅

- 캐싱은 지연시간 감소
- 스로틀링으로 API 호출 횟수 줄이고 제한가능
- cloudwatch에 로깅

### 스테이징과 버전 관리

- API당 10개의 스테이지 가능
- 스테이지 변수에 따라 엔드포인트도 다르게 호출 가능
- 배포될 때마다 버전 생성

---

## API Gateway를 사용해 일하기

### 계획

- s3 버킷의 비디오 리스트 출력

### 리소스와 메소드 만들기

- /videos path
- GET method
- proxy resource
  - /video/{proxy+} 와일드 카드라고 보면 된다.
- Lambda 프록시 통합
  - 모든 요청을 JSON에 매핑하여 이벤트 객체를 통ㅎ래 전달
  - 사용하지 않는다면, 통합요청에서 매핑템플릿을 만들어야함.
- CORS 추가
  - 어떠한 출처로부터 오는가.
  - 실제 운영 환경에서는 CORS를 열어두지 않고 도메인으로 제한
  
### 메소드 실행 구성

- 메소드 요청
  - 람다 프록시 통합 같은 경우 관련이 없음
  - 수동 매핑의 경우 부록E 참조
  - 사용자 정의 권한 모듈 선택
  
### Lambda 함수

- 입력 포맷
- 출력 포맷
  - 응답도 형식에 맞게 짜줘야 함
  - 형식에 맞지 않으면 502 Bad gatway 응답 반환
    - status code
    - header
    - body
  - 비디오 목록을 가져오는 Lambda함수 연결
- API 테스트

### 웹사이트 업데이트

- 비디오 리스트를 보여주기 위한 화면
  
---

## Gateway 최적화

### 스로틀링

- rate: 초당 호출할 수 있는 평균 횟수
- burst limit: 메소드를 호출할 수 있는 최대 횟수
- 정상상태 요청을 1000rps로 허용하고 최대 2000rps 버스트 허용 제한을 늘릴 수 는 있음
- 버스트 테스트
  - 사용자 정의 권한 모듈 비활성화
  - 200건 수행

### 로깅

- cloudwatch 로그
- enable cloudwatch logs 옵션으로 허용
- enable cloudwatch metric도 허용
- policy도 추가

### 캐싱

- 캐시를 어느 시점에 무효화 하는것도 중요
- 캐시를 무효화하는 것에 대해서는 제한을 할 수 있음

---

## 스테이지와 버전

### 스테이지 변수 생성

### 스테이지 변수 사용

- stageVariables.<variable_name> 으로 변수로서 활용 가능

### 버전

- 이전 버전으로 롤백 가능

---

## 연습문제

- 수동매핑
- 특정 인코딩의 비디오만 리스트업
- s3객체 이름을 올바르게 설정하는 법
- 파일이름 변경하는 함수 만들기
- 스테이지 여러개 사용

---

## 요약

- 자원생성 GET메소드 구성
- Lambda 프록시 통합
- API Gateway 응답 구성
- 스로틀 및 캐싱 로깅
- 스테이지 변수
